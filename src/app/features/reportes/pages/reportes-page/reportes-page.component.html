<style>
    .grayscale-select {
        filter: grayscale(1);
        background-color: #ececec;
        color: #333;
    }

    .grayscale-select:focus {
        filter: none;
    }
</style>

<div class="min-h-screen bg-base-200 p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold text-base-content mb-2"> Análisis de Riesgo Financiero</h1>
            <p class="text-base-content/70">
                Evaluación del riesgo de desviación presupuestal basado en el método de Valor Ganado (EAC)
            </p>
        </div>

        <!-- Selector de Proyecto -->
        <div class="card bg-base-100 shadow-xl mb-6">
            <div class="card-body">
                <h2 class="card-title">Selecciona un Proyecto</h2>

                <!-- Loading Proyectos -->
                <div *ngIf="loadingProyectos()" class="flex justify-center py-4">
                    <span class="loading loading-spinner loading-md text-success"></span>
                </div>

                <!-- Dropdown -->
                <div *ngIf="!loadingProyectos()" class="form-control w-full max-w-md">
                    <label class="label">
                        <span class="label-text font-semibold">Proyecto:</span>
                    </label>
                    <select class="select select-bordered border-slate-400 w-full text-base shadow-md grayscale-select"
                        [(ngModel)]="proyectoSeleccionado" (ngModelChange)="onProyectoSeleccionado($event)">
                        <option [ngValue]="null" disabled selected>Selecciona un proyecto...</option>
                        <option *ngFor="let proyecto of proyectos()" [ngValue]="proyecto.id">
                            {{ proyecto.nombre }} - {{ proyecto.ubicacion }}
                        </option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Loading Análisis (Skeleton) -->
        <div *ngIf="loading()" class="space-y-6 animate-pulse">
            <!-- KPI Cards Skeleton -->
            <div class="card bg-base-100 shadow-2xl">
                <div class="card-body">
                    <div class="h-8 bg-slate-200 rounded w-1/3 mb-4"></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="h-40 bg-slate-200 rounded"></div>
                        <div class="h-40 bg-slate-200 rounded"></div>
                    </div>
                </div>
            </div>

            <!-- Table Skeleton -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <div class="h-6 bg-slate-200 rounded w-1/4 mb-4"></div>
                    <div class="space-y-4">
                        <div class="h-10 bg-slate-200 rounded w-full"></div>
                        <div class="h-10 bg-slate-200 rounded w-full"></div>
                        <div class="h-10 bg-slate-200 rounded w-full"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error State -->
        <div *ngIf="error()" class="alert alert-error shadow-lg mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <div>
                <h3 class="font-bold">Error de Análisis</h3>
                <div class="text-xs">{{ error() }}</div>
            </div>
        </div>

        <!-- Resultados del Análisis -->
        <div *ngIf="!loading() && !error() && desviacion()" class="space-y-6">
            <!-- Card Principal: Nivel de Riesgo -->
            <div class="card bg-base-100 shadow-2xl">
                <div class="card-body">
                    <h2 class="card-title text-2xl mb-4">Resultado del Análisis</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Nivel de Riesgo -->
                        <div class="stat bg-base-200 rounded-lg p-6">
                            <div class="stat-title text-base-content/70 font-semibold mb-2">Nivel de Riesgo</div>
                            <div class="stat-value text-5xl mb-3">
                                <span class="badge text-2xl px-6 py-4"
                                    [ngClass]="getRiesgoColor(desviacion()!.riesgoDesviacion)">
                                    {{ getRiesgoIcon(desviacion()!.riesgoDesviacion) }} {{
                                    desviacion()?.riesgoDesviacion }}
                                </span>
                            </div>
                            <div class="stat-desc text-base-content/60">
                                Clasificación según desviación presupuestal
                            </div>
                        </div>

                        <!-- Desviación Porcentual -->
                        <div class="stat bg-base-200 rounded-lg p-6">
                            <div class="stat-title text-base-content/70 font-semibold mb-2">Desviación Porcentual</div>
                            <div class="stat-value text-5xl"
                                [ngClass]="desviacion()!.desviacionPorcentaje > 0 ? 'text-red-600' : 'text-green-600'">
                                {{ desviacion()?.desviacionPorcentaje | number:'1.2-2' }}%
                            </div>
                            <div class="stat-desc text-base-content/60">
                                vs. Presupuesto Estimado Original
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card: Análisis de Costos -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-xl mb-4"><i class="fa-solid fa-money-bill-trend-up"></i> Análisis de
                        Costos</h2>
                    <div class="overflow-x-auto">
                        <table class="table table-zebra">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th class="text-right">Monto</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="font-semibold">Costo Estimado (Presupuesto)</td>
                                    <td class="text-right">${{ desviacion()?.costoEstimado | number:'1.2-2' }}</td>
                                </tr>
                                <tr>
                                    <td class="font-semibold">Costo Proyectado Final (EAC)</td>
                                    <td class="text-right font-bold"
                                        [ngClass]="desviacion()!.costoProyectadoFinal > desviacion()!.costoEstimado ? 'text-red-600' : 'text-green-600'">
                                        ${{ desviacion()?.costoProyectadoFinal | number:'1.2-2' }}
                                    </td>
                                </tr>
                                <tr class="bg-base-200">
                                    <td class="font-bold">Diferencia</td>
                                    <td class="text-right font-bold"
                                        [ngClass]="(desviacion()!.costoProyectadoFinal - desviacion()!.costoEstimado) > 0 ? 'text-red-600' : 'text-green-600'">
                                        ${{ (desviacion()!.costoProyectadoFinal - desviacion()!.costoEstimado) |
                                        number:'1.2-2' }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Card: Mensaje del Sistema -->
            <div class="alert alert-info shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                    class="stroke-current flex-shrink-0 w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                    <h3 class="font-bold">Información del Algoritmo</h3>
                    <div class="text-sm">{{ desviacion()?.mensaje }}</div>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div *ngIf="!loading() && !error() && !desviacion()" class="text-center py-20">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 mx-auto text-base-300 mb-4" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
            <h2 class="text-2xl font-bold text-base-content mb-2">Selecciona un Proyecto</h2>
            <p class="text-base-content/70">Elige un proyecto en el selector superior para ver su análisis de riesgo
                financiero</p>
        </div>
    </div>
</div>